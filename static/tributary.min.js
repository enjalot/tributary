(function(){function l(b){$("#savePanel").on("click",function(c){d3.select("#syncing").style("display","block"),a.save_gist(b,"save",function(a,b){window.location=a})}),$("#forkPanel").on("click",function(c){d3.select("#syncing").style("display","block"),a.save_gist(b,"fork",function(a,b){window.location=a})}),$("#loginPanel").on("click",function(b){a.login_gist(a.loggedin,function(a,b){window.location=a})})}function m(c){var e=c.config;e.contexts=[];var f,g,h,i,j=e.get("endpoint");a.endpoint&&(j=a.endpoint),j==="delta"?(e.set("display","svg"),e.set("play",!0),e.set("loop",!0),e.set("autoinit",!0)):j==="cypress"?(e.set("display","canvas"),e.set("play",!0),e.set("autoinit",!0)):j==="hourglass"?(e.set("display","svg"),e.set("play",!0),e.set("autoinit",!0)):j==="curiosity"?(e.set("display","webgl"),e.set("play",!0),e.set("autoinit",!0)):j==="bigfish"?(e.set("display","svg"),e.set("play",!0),e.set("autoinit",!1),e.set("restart",!0)):j==="fly"?(e.set("display","canvas"),e.set("play",!0),e.set("autoinit",!1),e.set("restart",!0)):j==="ocean"&&e.set("display","div"),e.get("display")||e.set("display","svg"),e.set("endpoint","");var k=d.select("#edit");a.edit=k,c.models.each(function(c){i=c.get("type"),i==="js"?(f=new a.TributaryContext({config:e,model:c,el:b.node()}),e.contexts.push(f),f.render(),a.make_editor({model:c})):i==="json"&&(f=new a.JSONContext({config:e,model:c}),e.contexts.push(f),f.execute(),a.make_editor({model:c}))}),e.contexts.forEach(function(b){b.model.get("type")==="js"&&(a.autoinit=!0,b.execute(),a.autoinit=e.get("autoinit"))});var m=new a.ConfigView({el:"#config",model:e});m.render();var n=new a.FilesView({el:"#files",model:e});n.render();var o=new a.ControlsView({el:"#controls",model:e});o.render(),l(e),a.events.trigger("show",e.get("tab")),a.events.on("show",function(a){e.set("tab",a)}),a.dims.display_percent=e.get("display_percent"),a.events.trigger("resize"),a.events.on("resize",function(){e.set("display_percent",a.dims.display_percent)})}var a={};window.tributary=a,a.events=_.clone(Backbone.Events),a.data={},window.trib={},window.trib_options={},window.addEventListener("resize",function(b){a.events.trigger("resize",b)}),a.CodeModel=Backbone.Model.extend({defaults:{code:"",filename:"inlet.js",name:"inlet",type:"js",config:{coffee:!1,vim:!1,emacs:!1,hide:!1}},initialize:function(){this.binder()},binder:function(){this.on("error",this.handle_error)},handle_error:function(b){a.trace&&(console.trace(),console.log(b))},handle_coffee:function(){var a=this.get("code");return this.get("config").coffee&&(a=CoffeeScript.compile(a,{bare:!0})),a},local_storage:function(a){a||(a="");var b=this.get("filename")+"/code/"+a;return localStorage[b]},set_local_storage:function(a,b){var c=this.get("filename")+"/code/"+b;localStorage[c]=a}}),a.CodeModels=Backbone.Collection.extend({model:a.CodeModel}),a.Config=Backbone.Model.extend({defaults:{endpoint:"tributary","public":!0,require:[],tab:"edit",display_percent:.7,play:!1,loop:!1,restart:!1,autoinit:!0,pause:!0,loop_type:"period",bv:!1,nclones:15,clone_opacity:.4,duration:3e3,ease:"linear"},require:function(a,b){var c=this.get("require"),d=_.pluck(c,"url"),e=function(){return a(b,arguments)};require(d,e)},initialize:function(){this.on("hide",function(){this.contexts.forEach(function(a){a.model.trigger("hide")})},this)}}),a.ConfigView=Backbone.View.extend({render:function(){var b=this;d3.select(this.el).append("span").classed("config_title",!0).text("Display:");var c=d3.select(this.el).append("div").classed("displaycontrols",!0).selectAll("div.config").data(a.displays).enter().append("div").classed("config",!0),d=this.model.get("display");c.each(function(a){a.name===d&&d3.select(this).classed("config_active",!0)}),c.append("span").text(function(a){return a.name}),c.append("span").text(function(a){return" "+a.description}).classed("description",!0),c.on("click",function(a){d3.select(this.parentNode).selectAll("div.config").classed("config_active",!1),d3.select(this).classed("config_active",!0),b.model.set("display",a.name)}),d3.select(this.el).append("span").classed("config_title",!0).text("Time Controls:");var e=d3.select(this.el).append("div").classed("timecontrols",!0).selectAll("div.config").data(a.time_controls).enter().append("div").classed("config",!0);e.each(function(a){b.model.get(a.name)&&d3.select(this).classed("config_active",!0)}),e.append("span").text(function(a){return a.name}),e.append("span").text(function(a){return" "+a.description}).classed("description",!0),e.on("click",function(a){var c=!b.model.get(a.name);d3.select(this).classed("config_active",c),b.model.set(a.name,c)}),d3.select(this.el).append("span").classed("config_title",!0).text("Require:");var f=d3.select(this.el).append("div").classed("requirecontrols",!0),g=f.selectAll("div.config").data(this.model.get("require")).enter().append("div").classed("config",!0);g.append("span").text(function(a){return a.name}),g.append("span").text(function(a){return" "+a.url}).classed("description",!0),g.append("span").text("x").classed("delete",!0).on("click",function(a){var c=b.model.get("require"),d=c.indexOf(a);c.splice(d,1),b.model.set("require",c),b.$el.empty(),b.render()});var h=f.append("div").classed("config",!0);h.append("span").text("+ ");var i=h.append("div").text("name: ").style({display:"none"});i.append("input").attr({type:"text"});var j=h.append("div").text("url: ").style({display:"none"});j.append("input").text("url:").attr({type:"text"}),h.on("click",function(){i.style("display",""),j.style("display",""),i.select("input").node().focus();var a=function(){var a={name:i.select("input").node().value,url:j.select("input").node().value},c=b.model.get("require");c.push(a),b.model.set("require",c),b.$el.empty(),b.render()};i.on("keypress",function(){d3.event.charCode===13&&a()}),j.on("keypress",function(){d3.event.charCode===13&&a()})})}}),a.Context=Backbone.View.extend({initialize:function(){},execute:function(){},render:function(){}}),a.TributaryContext=a.Context.extend({initialize:function(){this.model.on("change:code",this.execute,this),a.events.on("execute",this.execute,this),this.config=this.options.config,this.config.on("change:display",this.set_display,this);var b=this.config;a.init=undefined,a.run=undefined,a.loop=b.get("loop"),a.autoinit=b.get("autoinit"),a.pause=b.get("pause"),a.loop_type=b.get("loop_type"),a.bv=b.get("bv"),a.nclones=b.get("nclones"),a.clone_opacity=b.get("clone_opacity"),a.duration=b.get("duration"),a.ease=d3.ease(b.get("ease")),a.t=0,a.reverse=!1,a.render=function(){},a.execute=function(){if(a.run!==undefined){var b=a.t;a.loop&&(b=a.ease(a.t)),a.run(a.g,b,0)}},a.timer={then:new Date,duration:a.duration,ctime:a.t},d3.timer(function(){a.render();if(a.pause)return!1;var c=new Date,d=c-a.timer.then,e;a.reverse?e=a.timer.ctime*d/a.timer.duration*-1:e=(1-a.timer.ctime)*d/a.timer.duration,a.t=a.timer.ctime+e;if(a.loop){if(a.t>=1||a.t<=0||a.t==="NaN")a.loop_type==="period"?(a.t=0,a.timer.then=new Date,a.timer.duration=a.duration,a.timer.ctime=a.t,a.reverse=!1):a.loop_type==="pingpong"?(a.t=!a.reverse,a.timer.then=new Date,a.timer.duration=a.duration,a.timer.ctime=a.t,a.reverse=!a.reverse):a.t!==0&&(a.t=1,a.pause=!0);a.t===!0&&(a.t=1),a.t===!1&&(a.t=0)}a.execute(),b.trigger("tick",a.t)})},execute:function(){var b=this.model.handle_coffee();try{a.initialize=new Function("g",b),a.initialize(a.g)}catch(c){return this.model.trigger("error",c),!1}try{window.trib={},window.trib_options={},trib=window.trib,trib_options=window.trib_options,a.autoinit&&a.clear(),this.clones&&$(this.clones.node()).empty(),a.bv&&this.make_clones(),a.initialize(a.g),a.autoinit&&a.init!==undefined&&a.init(a.g,0),a.execute()}catch(d){return this.model.trigger("error",d),!1}return this.model.trigger("noerror"),!0},render:function(){this.set_display()},set_display:function(){var b=this;this.$el.empty();var c=this.config.get("display");c==="svg"?this.make_svg():c==="canvas"?this.make_canvas():c==="webgl"?this.make_webgl():c==="div"?(this.g=d3.select(this.el),a.clear=function(){b.$el.empty()}):a.clear=function(){b.$el.empty()}},make_svg:function(){this.svg=d3.select(this.el).append("svg").attr({xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink","class":"tributary_svg"}),a.g=this.svg,a.clear=function(){$(a.g.node()).empty()}},make_canvas:function(){a.clear=function(){a.canvas.width=a.sw,a.canvas.height=a.sh,a.ctx.clearRect(0,0,a.sw,a.sh)},a.canvas=d3.select(this.el).append("canvas").classed("tributary_canvas",!0).node(),a.ctx=a.canvas.getContext("2d"),a.g=a.ctx},make_clones:function(){this.clones=this.svg.selectAll("g.clones").data([0]),this.clones.enter().append("g").attr("class","clones"),a.g=this.svg.selectAll("g.delta").data([0]),a.g.enter().append("g").attr("class","delta");var b=d3.range(a.nclones),c=this.clones.selectAll("g.bvclone").data(b).enter().append("g").attr("class","bvclone").style("opacity",a.clone_opacity);c.each(function(b,c){var d=c+1,e=d3.select(this);a.init(e,d);var f=a.ease(d/(a.nclones+1));a.run(e,f,d)})},make_webgl:function(){function b(){windowHalfX=a.sw/2,windowHalfY=a.sh/2,a.camera.aspect=a.sw/a.sh,a.camera.updateProjectionMatrix(),a.renderer.setSize(a.sw,a.sh)}container=this.el,a.camera=new THREE.PerspectiveCamera(70,a.sw/a.sh,1,1e3),a.camera.position.y=150,a.camera.position.z=500,a.scene=new THREE.Scene,THREE.Object3D.prototype.clear=function(){var a=this.children,b;for(b=a.length-1;b>=0;b--){var c=a[b];c.clear(),this.remove(c)}},a.renderer=new THREE.WebGLRenderer,a.renderer.setSize(a.sw,a.sh),container.appendChild(a.renderer.domElement),a.render=function(){a.renderer.render(a.scene,a.camera)},a.render(),a.events.on("resize",b,!1),a.clear=function(){a.scene.clear()}}}),a.JSONContext=a.Context.extend({initialize:function(){this.model.on("change:code",this.execute,this),this.model.on("change:code",function(){a.events.trigger("execute")})},execute:function(){try{var b=JSON.parse(this.model.get("code"));a[this.model.get("name")]=b}catch(c){return this.model.trigger("error",c),!1}return this.model.trigger("noerror"),!0},render:function(){}}),a.Editor=Backbone.View.extend({initialize:function(){this.config=this.model.get("config"),this.model.on("show",function(){d3.select(this.el).style("display","")},this),this.model.on("hide",function(){d3.select(this.el).style("display","none")},this)},render:function(){var a=this;d3.select(this.el).attr({"class":"editor"}),this.cm=CodeMirror(this.el,{mode:"javascript",theme:"lesser-dark",lineNumbers:!0,onChange:function(){var b=a.cm.getValue();a.model.set("code",b)}}),this.cm.setValue(this.model.get("code")),this.inlet=Inlet(this.cm),this.model.on("error",function(){d3.select(a.el).select(".CodeMirror-gutter").classed("error",!0)}),this.model.on("noerror",function(){d3.select(a.el).select(".CodeMirror-gutter").classed("error",!1)})}}),a.gist=function(b,c){a.gistid=b;var d={},e="?cachebust="+Math.random()*0xf12765df4c9b2;d3.json("https://api.github.com/gists/"+b+e,function(b){b.user===null||b.user===undefined?d.user={login:"anon",url:"",userid:-1}:d.user=b.user;var e;try{e=b.files["config.json"]}catch(f){e=!1}if(e)try{d.config=new a.Config(JSON.parse(e.content))}catch(g){d.config=new a.Config}else d.config=new a.Config;var h=_.keys(b.files);d.models=new a.CodeModels;var i,j,k,l=0,m;h.forEach(function(c){i=c.split("."),m=i[i.length-1],c!=="config.json"&&(j=new a.CodeModel({filename:c,name:i[0],code:b.files[c].content,type:m}),d.models.add(j))}),d.config.require(c,d)})},a.save_gist=function(b,c,d){var e=a.gistid||"",f={description:"just another inlet to tributary","public":b.get("public"),files:{}};b.contexts.forEach(function(a){f.files[a.model.get("filename")]={content:a.model.get("code")}}),f.files["config.json"]={content:JSON.stringify(b.toJSON())};if(b.display==="svg"){var g=d3.select("svg").node(),h=(new XMLSerializer).serializeToString(g);$.browser.webkit&&(h=h.replace(/ xlink/g," xmlns:xlink"),h=h.replace(/ href/g," xlink:href")),f.files["inlet.svg"]={content:h}}var i;c==="save"?i="/tributary/save":c==="fork"&&(i="/tributary/fork"),e.length>4&&(i+="/"+e);var j=this;$.post(i,{gist:JSON.stringify(f)},function(a){typeof a=="string"&&(a=JSON.parse(a));var b=a.id,c="/tributary/"+b;d(c,b)})},a.login_gist=function(b,c){var d;b?d="/github-logout":d="/github-login",d+="/tributary",a.gistid&&(d+="/"+a.gistid),c(d)},a.FilesView=Backbone.View.extend({initialize:function(){},render:function(){var b=this,c=d3.select(this.el).selectAll("div").data(this.model.contexts),d=c.enter().append("div").classed("fv",!0);d.on("click",function(c){b.model.trigger("hide"),c.model.trigger("show"),a.events.trigger("show","edit")}),d.append("span").text(function(a){return a.model.get("filename")});var e=d3.select(this.el).append("div").classed("fv",!0);e.append("span").text("+");var f=e.append("input").attr({type:"text"}).style({visibility:"hidden"});e.on("click",function(){f.style("visibility","visible"),f.node().focus(),f.on("keypress",function(){if(d3.event.charCode===13){var c=a.make_context({filename:f.node().value,config:b.model});b.model.contexts.push(c),a.make_editor({model:c.model}),b.$el.empty(),b.render()}})})}}),a.FileView=Backbone.View.extend({render:function(){}}),a.ControlsView=Backbone.View.extend({initialize:function(){this.model.on("change:play",this.play_button,this),this.model.on("change:loop",this.time_slider,this),this.model.on("change:restart",this.restart_button,this)},render:function(){var a=d3.select(this.el);a.append("div").attr("id","time_controls"),a.append("div").attr("id","user_controls"),a.append("div").attr("id","time_options"),this.play_button(),this.time_slider(),this.restart_button()},play_button:function(){var b=d3.select(this.el).select("#time_controls");if(this.model.get("play")){var c=b.append("button").classed("play",!0).classed("button_on",!0).text("Play");c.on("click",function(b){a.pause?a.pause&&(c.classed("playing",!0),c.text("Pause")):(c.classed("playing",!1),c.text("Play"));if(a.t<1||!a.loop)a.pause=!a.pause,a.pause||(a.timer.then=new Date,a.timer.duration=(1-a.t)*a.duration,a.timer.ctime=a.t)})}else b.select("button.play").remove()},time_slider:function(){a.loop=this.model.get("loop");var b=d3.select(this.el).select("#time_controls");if(a.loop){var c=b.append("input").attr({type:"range",min:0,max:1,step:.01,value:0,name:"time"}).classed("time_slider",!0);$(c.node()).on("change",function(){a.t=parseFloat(this.value),a.pause&&a.execute()}),this.model.on("tick",function(b){$(c.node()).attr("value",a.t)});if(this.model.get("display")==="svg"){var d=b.append("button").classed("bv",!0).classed("button_on",!0).text("BV");d.on("click",function(){a.bv=!a.bv,a.events.trigger("execute")})}}else a.bv=!1,b.select("input.time_slider").remove(),b.select("button.bv").remove()},restart_button:function(){var b=this,c=d3.select(this.el).select("#time_controls");if(this.model.get("restart")){a.autoinit=!1;var d=c.append("button").classed("restart",!0).classed("button_on",!0).text("Restart");d.on("click",function(b){a.clear(),a.init(a.g),a.execute()})}else a.autoinit=!0,c.select("button.restart").remove()}}),a.displays=[{name:"svg",description:"creates an <svg> element for you to use"},{name:"canvas",description:"creates a <canvas> element and gives you a Context for the canvas"},{name:"webgl",description:"gives you a Three.js WebGLRenderer scene"},{name:"div",description:"gives you a plain old <div>"}],a.time_controls=[{name:"play",description:"gives you a play button, and tributary.t. if you provide tributary.run(g,t) it will be executed in a run loop"},{name:"loop",description:"gives you a loop where tributary.t goes from 0 to 1."},{name:"restart",description:"assumes you only want tributary.init(g) to be run when the restart button is clicked"}],a.make_context=function(b){var c,d,e,f=b.config;b.filename?c=b.filename:c="inlet.js",b.content?d=b.content:d="",b.display?e=b.display:e=d3.select("#display");var g,h=c.split(".");ext=h[h.length-1];var i=new a.CodeModel({name:h[0],filename:c,code:d});return ext==="js"?g=new a.TributaryContext({config:f,model:i,el:e.node()}):ext==="json"?(g=new a.JSONContext({config:f,model:i}),g.execute()):ext!=="css"&&ext!=="html",g},a.make_editor=function(b){var c=b.model;b.container?container=b.container:container=a.edit.append("div").attr("id",c.cid);var d;return d=new a.Editor({el:container.node(),model:c}),d.render(),d},d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},a.ui={};var b=d3.select("#display"),c=d3.select("#panel_gui"),d=d3.select("#panel"),e=d3.select("#panel_handle"),f=d3.select("#page"),g=d3.select("#header");a.dims={display_percent:.7,page_width:0,page_height:0,display_width:0,display_height:0,panel_width:0,panel_height:0,panel_gui_width:0,panel_gui_height:40},a.events.on("resize",function(){a.dims.page_width=parseInt(f.style("width"),10),a.dims.page_height=parseInt(f.style("height"),10),a.dims.display_width=a.dims.page_width*a.dims.display_percent,a.dims.panel_width=a.dims.page_width-a.dims.display_width,a.dims.panel_gui_width=a.dims.panel_width,a.dims.display_height=a.dims.page_height-parseInt(g.style("height"),10),a.dims.panel_height=a.dims.display_height-a.dims.panel_gui_height,b.style("width",a.dims.display_width+"px"),b.style("height",a.dims.display_height+"px"),d.style("width",a.dims.panel_width+"px"),d.style("height",a.dims.panel_height+"px"),c.style("width",a.dims.panel_gui_width+"px"),c.style("height",a.dims.panel_gui_height+"px"),e.style("right",a.dims.panel_width+"px"),a.sw=a.dims.display_width,a.sh=a.dims.display_height}),a.events.trigger("resize");var h=d3.behavior.drag().on("drag",function(){var b=d3.event.dx/a.dims.page_width;a.dims.display_percent+b>=0&&a.dims.display_percent+b<=1&&(a.dims.display_percent+=b),a.events.trigger("resize")});e.call(h);var i=["edit","files","config","controls"],j=60,k=c.selectAll("div.pb").data(i).enter().append("div").classed("pb",!0).attr({id:function(a){return a+"_tab"}}).on("click",function(b){a.events.trigger("show",b)});k.text(function(a){return a}),a.events.on("show",function(a){$("#panel").children("div").css("display","none"),d.select("#"+a).style("display",""),c.selectAll("div.pb").classed("gui_active",!1),c.select("#"+a+"_tab").classed("gui_active",!0)}),a.events.trigger("show","edit"),a.ui.assemble=function(b){a.trace=!0;if(b.length>0)a.gist(b,m);else{var c={};c.config=new a.Config,c.models=new a.CodeModels(new a.CodeModel),m(c)}}})();